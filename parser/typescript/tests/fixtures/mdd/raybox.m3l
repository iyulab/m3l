# Namespace: umes.ray.raybox

@import "./mes.m3l"

> U-MES.Ray - RayBox Integration Layer
> RayBox (激光魔盒) IoT Gateway 연동 특화 레이어
> 지원 소프트웨어: CypCut (2D 평면절단), TubePro (파이프절단), CypOne, CypVision

## CutSoftwareType ::enum "절단 소프트웨어"

- CYPCUT "2D 평면 절단"
- TUBEPRO "파이프 절단"
- CYPONE "통합"
- CYPVISION "비전"

## CypCutSysState ::enum "CypCut 시스템 상태 코드"

- STANDBY: integer = 0
- SIMULATE: integer = 1
- JOG: integer = 2
- RETURN_ZERO: integer = 3
- RETURN_MARK: integer = 4
- RETURN_REF: integer = 5
- RETURN_ORIGIN: integer = 6
- FRAME: integer = 7
- MACHINING: integer = 8
- PAUSE: integer = 9
- RESUME: integer = 10
- FORWARD: integer = 11
- BACKWARD: integer = 12

## TubeProSysState ::enum "TubePro 시스템 상태 코드"

- IDLE: integer = 0
- MACHINING: integer = 1
- PAUSE: integer = 2
- EXECUTE_PLC: integer = 3
- JOGGING: integer = 4
- RETURN_ORIGIN: integer = 5
- UNKNOWN: integer = 6

## TubeProCutMode ::enum "TubePro 절단 모드"

- NORMAL: integer = 0
- DRY_RUN: integer = 1
- SIMULATE: integer = 2
- ERROR_MONITOR: integer = 3

## MachineOnlineStatus ::enum "설비 온라인 상태 (RayBox)"

- OFFLINE
- ALARMING
- IDLE
- WORKING
- UNKNOWN

## RayboxTaskStatus ::enum "RayBox 작업 상태"

- CREATED "생성됨"
- UPLOADED "업로드됨"
- ASSIGNED "배정됨"
- IN_PROGRESS "가공중"
- COMPLETED "완료"
- CANCELLED "취소"

---

## RayBoxServer(레이박스서버) : BaseEntity
> RayBox IoT 게이트웨이 서버 연결 정보

- name: string(200) @searchable "서버명"
- server_ip: string(50) @unique "서버 IP"
- server_port: integer = 8080 "API 포트"
- api_token: string(200)? "API 토큰"
- api_secret: string(200)? "API 시크릿 (암호화 저장)"
- token_expires_at: timestamp? "토큰 만료일"
- last_synced_at: timestamp? "최종 동기화 시각"
- is_active: boolean = true

---

## LaserMachine(레이저절단기) : BaseEntity
> 기본 Machine(mes.m3l)을 1:1 확장하여 레이저 절단기 고유 속성 관리

- machine_id: identifier @unique @reference(Machine) "MES 설비 (1:1)"
- raybox_id: identifier? @reference(RayBoxServer) @index "연결된 레이박스"

# RayBox 식별
- gmid: integer? @unique "RayBox 설비 고유 ID"
- server_ip: string(50)? "설비 IP"
- server_name: string(200)? "설비 PC명"
- mac_address: string(50)? "MAC 주소"

# 제어카드
- card_id: string(100)? "제어카드 ID"
- card_type: string(50)? "제어카드 유형 (BMC2104 등)"
- serial_number: string(100)? "시리얼번호"

# 레이저
- laser_type: string(100)? "레이저 유형 (Raycus 1000W, IPG 2000W 등)"
- laser_power_max: decimal(10, 1)? "최대 출력 (W)"

# 가공 영역
- cut_range_x: decimal(10, 2)? "가공 영역 X (mm)"
- cut_range_y: decimal(10, 2)? "가공 영역 Y (mm)"
- cut_range_label: string(50)? "가공 영역 라벨 (300x400 등)"

# 조고기/교환대
- bcs_type: string(50)? "조고기 유형 (BCS100 등)"
- bcs_id: string(100)? "조고기 ID"
- switch_table_num: integer? "교환대 수량"

# 소프트웨어
- primary_software: CutSoftwareType? "주 절단 소프트웨어"
- software_version: string(50)? "소프트웨어 버전"
- licence_valid_end: string(50)? "라이선스 만료일"

### Lookup
- machine_name: string @lookup(machine_id.name) "MES 설비명"
- machine_code: string @lookup(machine_id.code) "MES 설비코드"
- raybox_server: string? @lookup(raybox_id.name) "레이박스 서버명"

---

## CuttingTask(절단작업) : BaseEntity, Auditable
> MES WorkOrder -> CuttingTask -> RayBox upload/assign

- task_name: string(500) @searchable "작업명"
- task_identifier: string(100)? @unique "자체 작업 ID (RayBox taskIdentifier)"
- raybox_uuid: string(100)? "RayBox 내부 UUID"

# MES 연결
- work_order_id: identifier? @reference(WorkOrder) @index "작업지시"
- work_order_item_id: identifier? @reference(WorkOrderItem) "작업지시항목"

# 소재 정보
- material_name: string(100)? "소재명 (RayBox)"
- thickness: decimal(8, 2)? "두께 (mm)"
- plate_size: string(50)? "판재 사이즈 (2000x3000)"

# 파일
- file_name: string(500)? "가공 파일명 (zx, zzx, dxf, nrp2, lxds)"
- file_path: string(1000)? "파일 경로"
- thumbnail_url: string(1000)? "썸네일 URL"
- is_resolved: boolean = false "도면 해석 완료"

# 수량
- amount: integer = 1 "가공 수량"
- finished_amount: integer = 0 "완료 수량"

# 분류
- is_tube_task: boolean = false "파이프 절단 여부"
- tags: string(500)? "태그"
- estimate_secs: integer? "예상 소요시간 (초)"

# 상태
- status: RayboxTaskStatus = "CREATED" @index
- assigned_machine_id: identifier? @reference(Machine) @index "배정 절단기"
- uploaded_at: timestamp? "RayBox 업로드 시각"
- last_finish_time: timestamp? "최근 완료 시각"

### Lookup
- work_order_no: string? @lookup(work_order_id.order_no) "작업지시번호"
- assigned_machine_name: string? @lookup(assigned_machine_id.name) "배정 설비명"

### Rollup
- part_count: integer @rollup(CuttingTaskPart.cutting_task_id, count) "부품 종류수"
- total_qty: integer @rollup(CuttingTaskPart.cutting_task_id, sum(quantity)) "총 부품수량"

## CuttingTaskPart(절단작업부품) : BaseEntity

- cutting_task_id: identifier @reference(CuttingTask) @index "절단작업"
- part_id: identifier? @reference(Part) "부품 (MES 연결)"
- raybox_part_id: string(100)? "RayBox PartID"
- part_name: string(200) "부품명"
- quantity: integer = 1 "배치 내 수량"

---

## MachineStatusSnapshot(설비상태스냅샷) : BaseEntity
> RayBox API: /api/monitor/cutSystemState

- machine_id: identifier @reference(Machine) @index "절단기"
- recorded_at: timestamp = now() @index
- online_status: MachineOnlineStatus "온라인 상태" @index
- software_type: CutSoftwareType? "실행 소프트웨어"
- sys_state: integer? "시스템 상태 코드"
- cut_mode: integer? "절단 모드 (TubePro)"

# 축 위치
- axis_x: decimal(12, 3)? "X축 (mm)"
- axis_y: decimal(12, 3)? "Y축 (mm)"
- axis_z: decimal(10, 3)? "Z축 (mm)"
- axis_b: decimal(12, 3)? "B축 (TubePro, mm)"
- axis_a: decimal(12, 3)? "A축 (TubePro, mm)"

# 속도
- speed_x: decimal(10, 3)? "X축 속도 (TubePro, mm/s)"
- speed_y: decimal(10, 3)? "Y축 속도 (TubePro, mm/s)"
- speed_b: decimal(10, 3)? "B축 속도 (TubePro, mm/s)"
- speed_a: decimal(10, 3)? "A축 속도 (TubePro, mm/s)"
- work_speed: decimal(10, 2)? "가공 속도"
- trace_speed: decimal(12, 6)? "궤적 속도 (TubePro)"
- feed_rate: decimal(5, 2)? "진급 배율 (0-100)"

# 레이저
- laser_power: decimal(10, 1)? "레이저 출력 (W)"
- diode_current: decimal(5, 1)? "피크 파워 (%)"
- pwm_freq: decimal(10, 1)? "PWM 주파수 (Hz)"
- pwm_ratio: decimal(5, 3)? "PWM 듀티비"
- laser_ratio: decimal(5, 2)? "레이저 듀티비 (TubePro, 0-100)"
- is_laser_on: boolean? "레이저 ON"
- is_emission_on: boolean? "광문 개방"

# 가스/높이
- gas_type: string(50)? "가스 종류"
- gas_pressure: decimal(8, 2)? "가스 압력 (bar)"
- is_gas_on: boolean? "가스 ON"
- current_h: decimal(10, 2)? "추적 높이 실시간 (mm)"
- target_height: decimal(10, 2)? "추적 높이 설정 (mm)"
- is_following: boolean? "높이 추적 ON"
- focus_pos: decimal(10, 2)? "초점 위치 (TubePro, mm)"
- beam_size: decimal(10, 2)? "광반 크기 (TubePro)"

# 가공 진행
- cut_percent: decimal(5, 2)? "가공 진도 (%)"
- running_time: decimal(15, 10)? "운행 시간 (일)"
- work_time: decimal(15, 10)? "가공 시간 (일)"
- total_work_time: decimal(15, 4)? "누적 가공시간"
- task_name: string(500)? "현재 가공 파일명"

# TubePro 전용
- cur_part_num: integer? "현재 부품 완료 수"
- sum_part_num: integer? "도면 부품 총수"
- sum_parts: decimal(10, 1)? "누적 가공 부품수"
- sum_consumetime: decimal(15, 10)? "누적 가공시간 (일, 리셋 가능)"
- part_name: string(200)? "현재 부품명"
- nest_name: string(200)? "배치명"
- portion_id: string(200)? "배치 고유ID"
- file_id: string(200)? "파일 고유ID"

# 알람
- alarm_count: integer? "알람 수"
- alarm_msg: string(1000)? "알람 메시지"

# 기타
- station_index: integer? "공위 번호 (CypCut)"
- switch_table_num: integer? "교환대 수 (CypCut)"
- is_jog_fast: boolean? "고속 점동"
- is_aiming_on: boolean? "레드포인터 ON"

# CypCut 좌표
- ucs_org_x: decimal(12, 3)? "X축 영점"
- ucs_org_y: decimal(12, 3)? "Y축 영점"
- home_ref_x: decimal(12, 3)? "X축 정차점 기계좌표"
- home_ref_y: decimal(12, 3)? "Y축 정차점 기계좌표"
- cad_home_ref_x: decimal(12, 3)? "X축 정차점 CAD좌표"
- cad_home_ref_y: decimal(12, 3)? "Y축 정차점 CAD좌표"
- can_restore_from_stop: boolean? "단점계속 가능"
- da1: decimal(10, 4)? "DA1"
- da2: decimal(10, 4)? "DA2"
- outport_bytes: integer? "출력구 값"
- inport_bytes: integer? "입력구 값"

### Lookup
- machine_name: string @lookup(machine_id.name) "설비명"

---

## MachineStatusLog(설비상태이력) : BaseEntity
> RayBox API: /api/machine/status

- machine_id: identifier @reference(Machine) @index "절단기"
- app_name: string(50)? "소프트웨어명"
- last_state: MachineOnlineStatus "이전 상태"
- now_state: MachineOnlineStatus "현재 상태"
- changed_at: timestamp = now() @index "변경 시각"

### Lookup
- machine_name: string @lookup(machine_id.name) "설비명"

---

## MachiningRecord(가공기록) : BaseEntity
> RayBox API: /api/monitor/machine/history

- machine_id: identifier @reference(Machine) @index "절단기"
- cutting_task_id: identifier? @reference(CuttingTask) @index "절단작업"
- production_result_id: identifier? @reference(ProductionResult) @index "MES 생산실적"
- file_name: string(500)? "가공 파일명"
- start_time: timestamp @index "시작"
- end_time: timestamp? "종료 (null = 가공중)"
- time_taken_sec: integer? "소요시간 (초)"
- material_name: string(100)? "소재명"
- thickness: decimal(8, 2)? "두께 (mm)"
- plate_size: string(50)? "판재 사이즈"
- cut_length: decimal(12, 4)? "절단 길이 (mm)"
- move_length: decimal(12, 4)? "공이동 거리 (mm)"
- pierce_count: integer? "천공 수"
- part_count: integer? "완료 부품 수"
- count: integer? "가공 수량"

### Lookup
- machine_name: string @lookup(machine_id.name) "설비명"
- task_name: string? @lookup(cutting_task_id.task_name) "절단작업명"

### Rollup
- detail_part_count: integer @rollup(MachiningRecordPart.machining_record_id, count) "상세 부품 종류수"

## MachiningRecordPart(가공기록부품) : BaseEntity

- machining_record_id: identifier @reference(MachiningRecord) @index "가공기록"
- part_id: identifier? @reference(Part) "부품 (MES)"
- raybox_part_id: string(100)? "RayBox PartID"
- part_name: string(200) "부품명"
- amount: integer = 0 "완료 수량"

---

## RunningTechLog(가공파라미터기록) : BaseEntity
> RayBox API: /api/machine/running/tech

- machine_id: identifier @reference(Machine) @index "절단기"
- recorded_at: timestamp = now() @index
- tech_name: string(200)? "공정명 (시스템기본파라미터 등)"
- pwm_freq: decimal(10, 1)? "펄스 주파수 (Hz)"
- gas_pressure: decimal(8, 2)? "가스 압력 (bar)"
- laser_diode_current: decimal(5, 1)? "피크 파워 (0-100%)"
- work_speed: decimal(10, 2)? "절단 속도 (mm/s)"
- focus: decimal(8, 2)? "초점 위치 (mm)"

---

## MachineAlarm(설비알람) : BaseEntity
> RayBox API: /api/machine/alarm/v2

- machine_id: identifier @reference(Machine) @index "절단기"
- app_name: string(50)? "소프트웨어 (CypCut, TubePro)"
- alarm_code: integer? "알람 코드"
- alarm_class: string(100)? "알람 모듈 (SwitchTable 등)"
- alarm_desc: string(500)? "알람 설명"
- start_time: timestamp @index "발생 시각"
- remove_time: timestamp? "해제 시각"
- duration_sec: integer? "지속시간 (초)"
- acknowledged_by: string(100)? "확인자"

### Lookup
- machine_name: string @lookup(machine_id.name) "설비명"

---

## SoftwareInstanceLog(소프트웨어실행이력) : BaseEntity
> RayBox API: /api/machine/instance

- machine_id: identifier @reference(Machine) @index "절단기"
- app_name: string(50) "소프트웨어명 (CypCut, CypCutE, CypCutPro, TubePro)"
- app_version: string(50)? "버전"
- start_time: timestamp @index "실행 시각"
- exit_time: timestamp? "종료 시각 (null = 미종료)"

---

## DailyMachineStat(일별설비통계) : BaseEntity
> RayBox API: /api/statistic/daily/*

- machine_id: identifier @reference(Machine) @index "절단기"
- app_name: string(50)? "소프트웨어"
- stat_date: date @index "기준일"

# 거리/수량
- cut_length: decimal(15, 4) = 0 "절단 길이 (mm)"
- move_length: decimal(15, 4) = 0 "공이동 거리 (mm)"
- pierce_count: integer = 0 "천공 수"

# 시간 (초)
- work_time_sec: integer = 0 "가공시간"
- idle_time_sec: integer = 0 "대기시간"
- laser_time_sec: integer = 0 "출광시간"
- gas_time_sec: integer = 0 "개기시간"
- alarm_time_sec: integer = 0 "알람시간"

### Lookup
- machine_name: string @lookup(machine_id.name) "설비명"

### Computed
- total_time_sec: integer @computed("work_time_sec + idle_time_sec + alarm_time_sec") "총 운행시간"
- start_rate: decimal(5, 2)? @computed("CASE WHEN (work_time_sec + idle_time_sec + alarm_time_sec) > 0 THEN work_time_sec * 100.0 / (work_time_sec + idle_time_sec + alarm_time_sec) END") "가동률 (%)"
- cut_rate: decimal(5, 2)? @computed("CASE WHEN work_time_sec > 0 THEN laser_time_sec * 100.0 / work_time_sec END") "절단률 (%)"

- @unique(machine_id, app_name, stat_date) "일별통계 복합 유니크"

## PeriodMachineStat(기간설비통계) : BaseEntity
> RayBox API: /api/statistic/summary, /api/statistic/extreme

- machine_id: identifier @reference(Machine) @index "절단기"
- app_name: string(50)? "소프트웨어"
- start_date: date @index "시작일"
- end_date: date "종료일"

# 합계
- cut_length: decimal(15, 4) = 0 "총 절단 길이 (mm)"
- move_length: decimal(15, 4) = 0 "총 공이동 거리 (mm)"
- pierce_count: integer = 0 "총 천공 수"
- work_time_sec: integer = 0 "총 가공시간 (초)"
- idle_time_sec: integer = 0 "총 대기시간 (초)"
- laser_time_sec: integer = 0 "총 출광시간 (초)"
- gas_time_sec: integer = 0 "총 개기시간 (초)"
- alarm_time_sec: integer = 0 "총 알람시간 (초)"

### Computed
- start_rate: decimal(5, 2)? @computed("CASE WHEN (work_time_sec + idle_time_sec + alarm_time_sec) > 0 THEN work_time_sec * 100.0 / (work_time_sec + idle_time_sec + alarm_time_sec) END") "가동률 (%)"
- cut_rate: decimal(5, 2)? @computed("CASE WHEN work_time_sec > 0 THEN laser_time_sec * 100.0 / work_time_sec END") "절단률 (%)"

# 극값
- max_work_time_sec: integer? "최대 일 가공시간"
- min_work_time_sec: integer? "최소 일 가공시간"
- max_cut_length: decimal(15, 4)? "최대 일 절단길이"
- min_cut_length: decimal(15, 4)? "최소 일 절단길이"
- max_move_length: decimal(15, 4)? "최대 일 공이동거리"
- min_move_length: decimal(15, 4)? "최소 일 공이동거리"
- max_idle_time_sec: integer? "최대 일 대기시간"
- min_idle_time_sec: integer? "최소 일 대기시간"
- max_alarm_time_sec: integer? "최대 일 알람시간"
- min_alarm_time_sec: integer? "최소 일 알람시간"
- max_pierce_count: integer? "최대 일 천공수"
- min_pierce_count: integer? "최소 일 천공수"
- max_laser_time_sec: integer? "최대 일 출광시간"
- min_laser_time_sec: integer? "최소 일 출광시간"
- max_gas_time_sec: integer? "최대 일 개기시간"
- min_gas_time_sec: integer? "최소 일 개기시간"

### Lookup
- machine_name: string @lookup(machine_id.name) "설비명"

---

## GasConsumption(가스소비) : BaseEntity

- machine_id: identifier @reference(Machine) @index "절단기"
- record_date: date @index "기준일"
- gas_type: string(50)? "가스 종류 (N2, O2, Air 등)"
- gas_time_sec: integer = 0 "개기시간 (초)"
- estimated_volume: decimal(10, 2)? "추정 소비량 (L)"
- cost: decimal(12, 2)? "비용"

### Lookup
- machine_name: string @lookup(machine_id.name) "설비명"

## ConsumableUsage(소모품사용) : BaseEntity

- machine_id: identifier @reference(Machine) @index "절단기"
- item_type: string(100) "소모품 유형 (노즐, 보호유리, 포커싱렌즈, 콜리메이팅렌즈, 세라믹링 등)"
- item_name: string(200)? "제품명/규격"
- replaced_at: timestamp = now() @index "교체일시"
- replaced_by: string(100)? "교체자"
- usage_hours: decimal(10, 2)? "사용시간 (시)"
- cost: decimal(12, 2)? "비용"
- remark: string(500)?

### Lookup
- machine_name: string @lookup(machine_id.name) "설비명"
